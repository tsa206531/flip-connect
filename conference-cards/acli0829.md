# 0829 開發總結報告（acli0829）

## 本日完成項目（已完成）
- 首頁名片呈現邏輯調整
  - 第 1 張固定為「上傳名片」空卡片
  - 第 2 張起優先顯示「使用者自己的名片」，其後為其他使用者之卡片且隨機排序
  - 修正漸進式載入（infinite scroll）時重新排序導致的閃動與位置跑掉問題（加入 sortedCards 緩存、LoadMore 使用排序後資料）

- 「檢視我的卡片」功能
  - 首頁功能模組將「認識參與者」改為「檢視我的卡片」
  - 點擊後會彈出與卡片放大鏡相同的 CardModal
  - 若使用者上傳多張名片，會顯示「最新上傳」的一張（以 createdAt 比較，兼容多種型別）

- 後端 API 修正 userId
  - /api/cards：補回 userId 欄位（來源 Firestore）
  - /api/upload：本地備援儲存也加入 userId，回應 payload 也帶回 userId

- 管理後台密碼門禁（方案 A）
  - 新增 /admin/login 頁面提交密碼（）


- 後台抽卡開關（Toggle）
  - 在 /admin 頁面新增 Toggle 控制「/draw 是否允許抽卡」
  - /draw 讀取該狀態（每 10 秒輪詢）
    - 禁用時：按鈕變灰、不可點、文案顯示「禁止抽卡」
    - 啟用時：按鈕恢復可用、文案「開始抽卡」
  - 修正 Admin Toggle 附近文案：
    - 左側標籤顯示「關閉抽卡」
    - 右側固定顯示「開放抽卡」

- 抽卡開關狀態改存 Cloud Firestore（取代全域變數）
  - Firestore 結構：collection `appConfig` / doc `draw`
  - 欄位：enabled:boolean, updatedAt:serverTimestamp(), updatedBy
  - lib/appConfig.ts：封裝 getDrawToggle / setDrawToggle
  - /api/admin/draw-toggle：GET/POST 讀寫 Firestore、POST 需 admin_session

- 修正建置錯誤
  - 修復 /app/draw/page.tsx JSX 模板字串缺少 `}` 導致的 Unexpected token 錯誤

## 尚未完成 / 待處理
- 後台登出按鈕（UI）尚未加到 /admin 頁面（API 已有 /api/admin/logout）
- Rate limit / 失敗次數限制：/api/admin/login 尚未加節流或風險控管
- CSRF 防護：敏感 POST/DELETE API 未加 CSRF Token（目前僅靠 HttpOnly Cookie）
- /draw 的開關狀態目前採用輪詢（polling）10 秒更新，尚未改成即時（SSE/WebSocket/Firestore onSnapshot）
- /api/cards 尚未支援查詢參數（分頁、排序模式、過濾）與隨機化在後端完成
- 首頁的 mock 資料合併策略是簡單去重，仍有小機率碰撞（同名同職位）
- Next.js 版本提示過舊（14.2.16）僅記錄，未升級及驗證
- Base64 圖片儲存在 global.cardsStorage 僅作備援，未移除或改用更妥當的存儲（如 Cloud Storage）

## 未來可以優化
- 安全性
  - 升級為 Firebase Admin + Custom Claims（admin: true），以帳號權限管理取代單一密碼
  - 對敏感 API 加入 CSRF、Rate Limit、審計日誌（誰在何時進行何操作）
  - 在 Firestore 紀錄切換抽卡狀態的日誌（collection: appLogs），顯示在 /admin

- 使用者體驗
  - /draw 改用 Firestore onSnapshot 或 SSE/WS 進行「抽卡開關」即時同步
  - /admin 標示抽卡狀態最後更新時間與更新者
  - 「檢視我的卡片」若沒有名片：導流到上傳流程或自動捲動到第 1 張「上傳名片」

- 功能完備
  - /api/cards 改為支援分頁 / 過濾 / 後端隨機化排序，減少前端負擔
  - 移除或最小化 mock 資料依賴，或加上標記來源避免誤用
  - 名片圖檔改存 Cloud Storage，減少 Base64 與記憶體佔用

- 品質保障
  - 加入端對端（E2E）與整合測試：
    - 進入 /admin -> 登入 -> 切換開關 -> /draw 反映狀態
    - 首頁排序、漸進式載入穩定性
    - /api/upload 與 Firestore ID 欄位一致性

## 下次優先事項（Priority）
- 每個 Google 帳號限制只能上傳「一張」名片
  - 後端（強制）：在 /api/upload 之前查詢 Firestore `cards` 是否已有該 userId 的卡片，若存在則拒絕（可回覆 409 Conflict + 訊息）
  - 前端（預防）：上傳頁面/入口若偵測到使用者已有卡片，改為禁用或提供「更新名片」流程
  - 若需要「更新」：可改為覆蓋該使用者現有卡片或建立版本機制（以相同 document id setDoc merge: true）

---
若需要，我可以在下一次提交中：
1) 完成「每帳號僅允許一張名片」的後端檢查與前端提醒
2) 在 /admin 加上「登出」按鈕與最後更新者/時間顯示
3) 將抽卡開關從輪詢改為 Firestore onSnapshot 即時更新
