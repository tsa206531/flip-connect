# UX3 三刀流交流研討會 - 開發進度報告

**日期：** 2025-01-26  
**專案：** Conference Cards Interactive Platform  
**開發者：** acli + RovoDev AI Assistant

---

## 📋 目前已完成的功能

### 1. 基礎架構 ✅
- **Next.js 14** 應用程式框架
- **TypeScript** 類型安全
- **Tailwind CSS** 樣式系統
- **Framer Motion** 動畫效果
- **響應式設計** 支援手機、平板、桌面

### 2. 用戶介面 ✅
- **首頁設計** - 動態標題、功能特色展示
- **卡片網格系統** - 響應式卡片佈局
- **互動式卡片** - 3D翻轉效果、懸停光效
- **抽卡頁面** - 隨機抽卡功能、抽卡記錄
- **上傳頁面** - 拖拽上傳、圖片預覽

### 3. Firebase 整合 ✅
- **Firebase 專案設定** - 完整配置
- **Google Authentication** - 一鍵登入系統
- **Cloud Firestore** - 資料庫設定
- **用戶狀態管理** - AuthContext 實作

### 4. 資料管理 ✅
- **卡片上傳功能** - 支援正面/背面圖片
- **Firestore 資料儲存** - 用戶資料 + 卡片資料
- **本地存儲備份** - 雙重儲存機制
- **資料讀取整合** - Firestore + 本地存儲合併

### 5. 用戶體驗 ✅
- **登入保護機制** - 未登入用戶導向
- **用戶選單系統** - 頭像顯示、登出功能
- **錯誤處理** - 友善的錯誤提示
- **載入狀態** - 載入動畫效果

---

## 🔧 最近修復的問題

### 技術問題修復
1. **Firebase SDK 安裝** - 解決模組找不到問題
2. **用戶選單定位** - 修復螢幕切斷問題
3. **重複變數定義** - 修復 router 重複宣告
4. **變數作用域** - 修復 userId 作用域問題
5. **Firestore 安全規則** - 設定正確的讀寫權限

---

## 🚀 接下來要做的功能

### 1. 高優先級 (下次開發重點)
- [x] **測試上傳功能** - ✅ 已確認可以成功上傳到 Firestore
- [ ] **修復重複卡片問題** - 解決 Firestore + 本地存儲重複顯示問題
- [ ] **API 路由保護** - 上傳 API 加入 JWT token 驗證
- [ ] **用戶卡片管理** - 讓用戶可以查看/編輯/刪除自己的卡片
- [ ] **圖片儲存優化** - 使用 Firebase Storage 儲存圖片

### 2. 中優先級 (優化與體驗)
- [ ] **圖片壓縮優化** - 減少上傳檔案大小和讀取時間
- [ ] **localStorage 緩存** - 緩存已抽卡片ID，減少重複查詢
- [ ] **圖片 CDN 整合** - 使用 Cloudflare 等 CDN 加速圖片載入
- [ ] **行動裝置優化** - 大拇指區域按鈕佈局 + 觸控震動回饋
- [ ] **Service Worker** - 離線緩存和背景同步
- [ ] **分頁載入** - 避免一次載入所有卡片
- [ ] **卡片模板下載** - 實作 Figma 模板下載功能

### 3. 低優先級
- [ ] **卡片分類系統** - 按部門、技能分類
- [ ] **社交功能** - 卡片點讚、收藏
- [ ] **統計分析** - 抽卡統計、熱門卡片
- [ ] **多語言支援** - 英文版本

---

## 🔄 下次開發啟動指南

### 1. 環境準備
```bash
# 1. 啟動開發伺服器
npm run dev
# 或
pnpm dev

# 2. 開啟瀏覽器
http://localhost:3000
```

### 2. 當前狀態檢查
- [ ] 確認 Google 登入功能正常
- [ ] 測試卡片上傳到 Firestore
- [ ] 檢查首頁是否顯示 Firestore 卡片
- [ ] 驗證抽卡功能是否包含新上傳的卡片

### 3. 已知問題待解決
- **✅ 上傳功能** - 已修復，可以成功上傳到 Firestore
- **⚠️ 重複卡片顯示** - 上傳後會顯示2張相同卡片（1張來自Firestore，1張來自本地存儲）
- **圖片儲存** - 目前使用 base64，需要改為 Firebase Storage
- **錯誤處理** - 需要更詳細的錯誤訊息顯示

### 4. 開發重點提醒
1. **先確保基本功能穩定** - 上傳、顯示、抽卡
2. **逐步添加新功能** - 避免一次性大改動
3. **保持測試習慣** - 每次修改後立即測試
4. **注意用戶體驗** - 載入狀態、錯誤提示、響應式設計

---

## 📁 重要檔案結構

```
conference-cards/
├── app/
│   ├── page.tsx              # 首頁
│   ├── upload/page.tsx       # 上傳頁面
│   ├── draw/page.tsx         # 抽卡頁面
│   └── api/
│       ├── cards/route.ts    # 卡片 API
│       └── upload/route.ts   # 上傳 API
├── components/
│   ├── user-menu.tsx         # 用戶選單
│   ├── google-login-modal.tsx # 登入彈窗
│   ├── card-grid.tsx         # 卡片網格
│   └── interactive-card.tsx  # 互動卡片
├── contexts/
│   └── AuthContext.tsx       # 認證上下文
├── lib/
│   ├── firebase.ts           # Firebase 配置
│   └── firestore.ts          # Firestore 服務
└── public/
    └── carddata.json         # 假資料 (測試用)
```

---

## 🔧 重點改進項目詳細說明

### 1. API 路由保護
```typescript
// middleware.ts - JWT 驗證中間件
import { NextRequest } from 'next/server'
import { verifyIdToken } from '@/lib/firebase-admin'

export async function middleware(request: NextRequest) {
  if (request.nextUrl.pathname.startsWith('/api/upload')) {
    const token = request.headers.get('authorization')?.replace('Bearer ', '')
    
    if (!token) {
      return new Response('Unauthorized', { status: 401 })
    }
    
    try {
      await verifyIdToken(token)
    } catch (error) {
      return new Response('Invalid token', { status: 401 })
    }
  }
}
```

### 2. 圖片 CDN 整合
```typescript
// 圖片 URL 處理
const getOptimizedImageUrl = (originalUrl: string, width?: number) => {
  // Cloudflare Images 或其他 CDN
  const baseUrl = 'https://imagedelivery.net/your-account-id'
  return `${baseUrl}/${originalUrl}/w=${width || 800},q=80`
}
```

### 3. Service Worker 離線支援
```javascript
// public/sw.js
self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/api/cards')) {
    event.respondWith(
      caches.match(event.request)
        .then(response => response || fetch(event.request))
    )
  }
})
```

### 4. 行動裝置觸控優化
```typescript
// 大拇指區域設計 (底部 120px 區域)
const MobileLayout = () => (
  <div className="pb-safe-bottom">
    {/* 主要內容 */}
    <main className="pb-32">...</main>
    
    {/* 大拇指區域 - 重要按鈕 */}
    <div className="fixed bottom-0 left-0 right-0 h-32 bg-black/90 backdrop-blur">
      <div className="flex justify-center items-center h-full px-6">
        <Button 
          className="w-full max-w-sm h-14 text-lg"
          onClick={handlePrimaryAction}
          onTouchStart={() => navigator.vibrate?.(50)} // 觸控震動
        >
          主要操作
        </Button>
      </div>
    </div>
  </div>
)
```

### 5. 觸控震動回饋
```typescript
// 觸控回饋工具函數
export const hapticFeedback = {
  light: () => navigator.vibrate?.(10),
  medium: () => navigator.vibrate?.(50),
  heavy: () => navigator.vibrate?.(100),
  success: () => navigator.vibrate?.[50, 50, 50],
  error: () => navigator.vibrate?.[100, 50, 100]
}

// 使用範例
<Button 
  onTouchStart={() => hapticFeedback.light()}
  onClick={() => {
    // 操作成功
    hapticFeedback.success()
  }}
>
  按鈕
</Button>
```

---

## 💰 Firebase 費用優化策略

### 1. 圖片優化方案

#### **壓縮策略**
```javascript
// 前端圖片壓縮 (建議實作)
const compressImage = (file, maxWidth = 800, quality = 0.8) => {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas')
    const ctx = canvas.getContext('2d')
    const img = new Image()
    
    img.onload = () => {
      // 計算新尺寸 (保持比例)
      const ratio = Math.min(maxWidth / img.width, maxWidth / img.height)
      canvas.width = img.width * ratio
      canvas.height = img.height * ratio
      
      // 繪製並壓縮
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
      canvas.toBlob(resolve, 'image/jpeg', quality)
    }
    
    img.src = URL.createObjectURL(file)
  })
}
```

#### **檔案大小限制**
- **目標大小**: 每張圖片 < 200KB
- **解析度**: 最大 800x800px
- **格式**: JPEG (壓縮率更好)
- **品質**: 80% (平衡品質與大小)

#### **載入優化**
- **懶加載**: 只載入可見的卡片圖片
- **縮圖系統**: 列表顯示用小圖，點擊才載入大圖
- **WebP 格式**: 現代瀏覽器支援，檔案更小

### 2. localStorage 緩存策略

#### **緩存結構設計**
```javascript
// localStorage 資料結構
const cacheStructure = {
  cards: {
    data: [], // 卡片資料
    lastUpdate: timestamp, // 最後更新時間
    version: "1.0" // 版本控制
  },
  drawnCards: {
    ids: [], // 已抽卡片ID列表
    history: [], // 抽卡歷史 (最近20次)
    lastDraw: timestamp
  },
  userPreferences: {
    theme: "dark",
    language: "zh-TW"
  }
}
```

#### **緩存策略**
1. **首次載入**: 從 Firestore 獲取 → 存入 localStorage
2. **後續載入**: 先讀 localStorage → 背景更新 Firestore
3. **資料同步**: 每5分鐘檢查一次更新
4. **容量管理**: 限制緩存大小，自動清理舊資料

#### **實作優先級**
```javascript
// 1. 卡片列表緩存 (高優先級)
const getCachedCards = () => {
  const cached = localStorage.getItem('cards')
  if (cached && !isExpired(cached.lastUpdate)) {
    return cached.data // 直接使用緩存
  }
  return fetchFromFirestore() // 緩存過期才查詢
}

// 2. 抽卡歷史緩存 (中優先級)
const cacheDrawnCard = (cardId) => {
  const drawn = JSON.parse(localStorage.getItem('drawnCards') || '[]')
  drawn.unshift(cardId)
  localStorage.setItem('drawnCards', JSON.stringify(drawn.slice(0, 20)))
}
```

### 3. Firestore 讀取優化

#### **查詢優化**
- **分頁載入**: 每次只載入 20 張卡片
- **索引優化**: 為常用查詢建立索引
- **條件查詢**: 避免全表掃描

#### **寫入優化**
- **批次寫入**: 多個操作合併為一次
- **離線支援**: 網路不穩時暫存本地

### 4. 費用估算

#### **目前使用量 (預估)**
- **讀取**: 每用戶每天 ~50 次
- **寫入**: 每用戶每天 ~5 次
- **儲存**: 每張卡片 ~1KB (不含圖片)

#### **優化後預期**
- **讀取減少**: 70% (緩存命中)
- **檔案大小**: 減少 60% (圖片壓縮)
- **總費用**: 預估減少 50-70%

---

## 💡 RovoDev 繼續開發指令

**下次啟動時，請告訴 RovoDev：**

> "請繼續開發 UX3 研討會名片平台。目前已完成 Firebase 整合和基本功能，需要：
> 1. 測試並修復卡片上傳到 Firestore 的功能
> 2. 實作用戶卡片管理功能
> 3. 優化圖片儲存方案
> 
> 請先檢查 acli0826.md 報告了解目前進度。"

---

**專案狀態：** 🟡 開發中 (核心功能已完成 80%)  
**下次重點：** 🎯 確保 Firestore 上傳功能正常運作